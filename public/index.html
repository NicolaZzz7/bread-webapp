<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçû –ö–∞—Ç–∞–ª–æ–≥ —Ö–ª–µ–±–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #48bb78;
            --primary-dark: #38a169;
            --bg-color: #ffffff;
            --text-color: #2d3748;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #1a202c;
                --text-color: #e2e8f0;
                --card-bg: #2d3748;
                --border-color: #4a5568;
                --shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 100%;
            padding: 16px;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
            padding: 20px 0;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
            color: var(--text-color);
        }

        .header p {
            color: #718096;
            font-size: 16px;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            background: var(--card-bg);
            color: var(--text-color);
            transition: border-color 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .product-grid {
            display: grid;
            gap: 16px;
        }

        .product-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .product-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .product-emoji {
            font-size: 40px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .product-info {
            flex: 1;
        }

        .product-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-color);
        }

        .product-ingredients {
            font-size: 14px;
            color: #718096;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .product-meta {
            display: flex;
            gap: 12px;
            font-size: 13px;
            color: #718096;
            margin-bottom: 16px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .price-section {
            margin-bottom: 16px;
        }

        .price-options {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .price-option {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: var(--bg-color);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .price-option.selected {
            border-color: var(--primary);
            background: rgba(72, 187, 120, 0.1);
        }

        .price-option .weight {
            font-weight: 600;
            color: var(--text-color);
        }

        .price-option .price {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary);
        }

        .add-button {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .add-button:hover {
            background: var(--primary-dark);
        }

        .add-button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }

        .cart-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 18px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .cart-indicator:hover {
            transform: scale(1.1);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #718096;
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .loading .spinner {
            font-size: 32px;
            margin-bottom: 16px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 480px) {
            .container {
                padding: 12px;
            }

            .header h1 {
                font-size: 24px;
            }

            .product-card {
                padding: 16px;
            }

            .price-options {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçû –ö–∞—Ç–∞–ª–æ–≥ —Ö–ª–µ–±–∞</h1>
            <p>–°–≤–µ–∂–∞—è –≤—ã–ø–µ—á–∫–∞ –Ω–∞ –∑–∞–∫–≤–∞—Å–∫–µ</p>
        </div>

        <div class="search-box">
            <input type="text" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ —Å–æ—Å—Ç–∞–≤—É...">
        </div>

        <div id="productGrid" class="product-grid">
            <div class="loading">
                <div class="spinner">‚è≥</div>
                <div>–ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥...</div>
            </div>
        </div>
    </div>

    <div id="cartIndicator" class="cart-indicator" style="display: none;" onclick="openCart()">
        <span id="cartCount">0</span>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let products = [];
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let selectedWeights = {};

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞
        async function loadCatalog() {
            try {
                const response = await fetch('/api/catalog');
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');

                products = await response.json();
                renderProducts(products);
                updateCartIndicator();

            } catch (error) {
                document.getElementById('productGrid').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üòï</div>
                        <div>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥</div>
                        <div style="margin-top: 8px; font-size: 14px;">${error.message}</div>
                    </div>
                `;
                console.error('Error loading catalog:', error);
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
        function renderProducts(productsToRender) {
            const grid = document.getElementById('productGrid');

            if (!productsToRender || productsToRender.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üîç</div>
                        <div>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
                        <div style="margin-top: 8px; font-size: 14px;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</div>
                    </div>
                `;
                return;
            }

            grid.innerHTML = Object.entries(productsToRender).map(([productId, product]) => {
                const availableWeights = Object.entries(product.prices || {})
                    .filter(([weight, price]) => price > 0)
                    .map(([weight, price]) => ({ weight, price }));

                const defaultWeight = availableWeights.length > 0 ? availableWeights[0].weight : null;
                selectedWeights[productId] = selectedWeights[productId] || defaultWeight;

                return `
                    <div class="product-card" data-product-id="${productId}">
                        <div class="product-header">
                            <div class="product-emoji">${getBreadEmoji(product.name)}</div>
                            <div class="product-info">
                                <div class="product-name">${product.name}</div>
                                <div class="product-ingredients">${product.ingredients || '–°–æ—Å—Ç–∞–≤ –Ω–µ —É–∫–∞–∑–∞–Ω'}</div>
                                <div class="product-meta">
                                    <div class="meta-item">‚è∞ ${product.prep_time || '1-2 –¥–Ω—è'}</div>
                                    ${product.addons ? `<div class="meta-item">‚ú® ${product.addons}</div>` : ''}
                                </div>
                            </div>
                        </div>

                        ${availableWeights.length > 0 ? `
                            <div class="price-section">
                                <div class="price-options">
                                    ${availableWeights.map(({weight, price}) => `
                                        <div class="price-option ${selectedWeights[productId] === weight ? 'selected' : ''}"
                                             onclick="selectWeight('${productId}', '${weight}')">
                                            <div class="weight">${weight}–≥</div>
                                            <div class="price">${price}‚ÇΩ</div>
                                        </div>
                                    `).join('')}
                                </div>

                                <button class="add-button" onclick="addToCart('${productId}')">
                                    üõí –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É ‚Ä¢ ${getProductPrice(productId)}‚ÇΩ
                                </button>
                            </div>
                        ` : `
                            <div style="text-align: center; color: #718096; padding: 10px;">
                                –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        // –ü–æ–ª—É—á–∏—Ç—å —ç–º–æ–¥–∑–∏ –¥–ª—è —Ö–ª–µ–±–∞
        function getBreadEmoji(name) {
            if (name.toLowerCase().includes('—Ä–∂–∞–Ω–æ–π')) return 'üçû';
            if (name.toLowerCase().includes('–ø—à–µ–Ω–∏—á–Ω—ã–π')) return 'ü•ñ';
            if (name.toLowerCase().includes('–±–æ—Ä–æ–¥–∏–Ω—Å–∫–∏–π')) return 'ü•®';
            if (name.toLowerCase().includes('–∑–µ—Ä–Ω–æ–≤–æ–π')) return 'üåæ';
            if (name.toLowerCase().includes('—Å—ã—Ä')) return 'üßÄ';
            if (name.toLowerCase().includes('–∫–ª—é–∫–≤')) return 'ü´ê';
            if (name.toLowerCase().includes('—à–æ–∫–æ–ª–∞–¥')) return 'üç´';
            return 'üçû';
        }

        // –í—ã–±–æ—Ä –≤–µ—Å–∞
        function selectWeight(productId, weight) {
            selectedWeights[productId] = weight;

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            document.querySelectorAll(`[data-product-id="${productId}"] .price-option`).forEach(option => {
                option.classList.toggle('selected', option.querySelector('.weight').textContent === weight + '–≥');
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
            const button = document.querySelector(`[data-product-id="${productId}"] .add-button`);
            if (button) {
                button.innerHTML = `üõí –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É ‚Ä¢ ${getProductPrice(productId)}‚ÇΩ`;
            }
        }

        // –ü–æ–ª—É—á–∏—Ç—å —Ü–µ–Ω—É –ø—Ä–æ–¥—É–∫—Ç–∞
        function getProductPrice(productId) {
            const product = products[productId];
            const weight = selectedWeights[productId];
            return product.prices[weight] || 0;
        }

        // –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É
        function addToCart(productId) {
            const product = products[productId];
            const weight = selectedWeights[productId];
            const price = getProductPrice(productId);

            if (!weight || !price) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Å –ø—Ä–æ–¥—É–∫—Ç–∞', 'error');
                return;
            }

            const cartItem = {
                id: productId,
                name: product.name,
                weight: weight,
                price: price,
                emoji: getBreadEmoji(product.name)
            };

            cart.push(cartItem);
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartIndicator();

            // –í–∏–±—Ä–∞—Ü–∏—è
            Telegram.WebApp.HapticFeedback.impactOccurred('light');

            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification(`${product.name} (${weight}–≥) –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!`, 'success');
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫–æ—Ä–∑–∏–Ω—ã
        function updateCartIndicator() {
            const indicator = document.getElementById('cartIndicator');
            const countElement = document.getElementById('cartCount');

            countElement.textContent = cart.length;
            indicator.style.display = cart.length > 0 ? 'flex' : 'none';
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        function showNotification(message, type = 'info') {
            Telegram.WebApp.showPopup({
                title: type === 'success' ? '‚úÖ –£—Å–ø–µ—à–Ω–æ' : '‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ',
                message: message,
                buttons: [{ type: 'ok' }]
            });
        }

        // –û—Ç–∫—Ä—ã—Ç—å –∫–æ—Ä–∑–∏–Ω—É
        function openCart() {
            if (cart.length === 0) {
                showNotification('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞', 'info');
                return;
            }

            const cartSummary = cart.map(item =>
                `${item.emoji} ${item.name} (${item.weight}–≥) - ${item.price}‚ÇΩ`
            ).join('\n');

            const total = cart.reduce((sum, item) => sum + item.price, 0);

            Telegram.WebApp.showConfirm(
                `–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞:\n\n${cartSummary}\n\nüíé –ò—Ç–æ–≥–æ: ${total}‚ÇΩ`,
                '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑?',
                (confirmed) => {
                    if (confirmed) {
                        Telegram.WebApp.sendData(JSON.stringify({
                            action: 'checkout',
                            cart: cart,
                            total: total
                        }));
                    }
                }
            );
        }

        // –ü–æ–∏—Å–∫
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();

            if (!searchTerm) {
                renderProducts(products);
                return;
            }

            const filteredProducts = Object.entries(products).reduce((acc, [id, product]) => {
                if (product.name.toLowerCase().includes(searchTerm) ||
                    (product.ingredients && product.ingredients.toLowerCase().includes(searchTerm))) {
                    acc[id] = product;
                }
                return acc;
            }, {});

            renderProducts(filteredProducts);
        });

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadCatalog();
    </script>
</body>
</html>